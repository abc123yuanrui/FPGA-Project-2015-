module jianpan(
					clk,
					inrow,outcol,//行输入，列读出
					key_value,//键值
					key_ready,//按键标志位
					lemp,lemp_0,lemp_1,lemp_2,lemp_3,lemp_4,lemp_5,lemp_6,lemp_7,lemp_8,lemp_9//键盘指示灯
					
				);

input   clk;                            //时钟25mhz
input   [3:0]   inrow;                  
output  [3:0]   outcol;                 
output  [4:0]   key_value;              
output  key_ready;                      
output reg lemp;
output reg lemp_0;
output reg lemp_1;
output reg lemp_2;
output reg lemp_3;
output reg lemp_4;
output reg lemp_5;
output reg lemp_6;
output reg lemp_7;
output reg lemp_8;
output reg lemp_9;
reg     clock;                          //定义25时钟
reg     clock_2;                          //定义25K时钟
reg     clock_3;  
reg     key_flag;                       //按键标志位
reg     jud_flag;                       //按键标志位
reg     [3:0]   col;                    //行输入扫描值
reg     [3:0]   inrow_reg;              //寄存扫描列值
reg     [3:0]   outcol_reg;             //寄存扫描行值
reg     [2:0]   state;                  //状态标志-判断是否有按键按下
reg     [4:0]   key_value;              //读取按键值
reg     [15:0]  count;
reg     [15:0]  count_2;
reg     [15:0]  count_3;
reg     [30:0]  count_4;
reg     [7:0]   keynum_1;              //寄存扫描列值
reg     [7:0]   key_num0;              //寄存扫描列值

//产生25hz时钟
always@(posedge clk)                    
begin
    count<=count+1;
    if(count>=15'd500000)                          
    begin
        clock<=~clock;
        count<=0;                         
    end
end
////////////////////////////////////////////
//通过6状态状态机完成对键盘的扫描：总确定是否有按键―>逐行扫描―>统一处理
always@(posedge clock)
begin
case(state)
    0:                                            //初值0
    begin
        col<=4'b0000;                             //行扫描输入值
        key_flag<=1'b0;
        if(inrow!=4'b1111)                        //有键按下
        begin
            state<=1;
            col<=4'b1110;                         //开始扫描
        end
        else state<=0;                            //总体判断是否有按键按下，确定按键标志位
    end
    1:
    begin
        if(inrow!=4'b1111)
        begin
            state<=5;                              //有按键时直接进入状态5
        end     
        else
        begin
            state<=2;
            col<=4'b1101;
        end
    end
    2:
    begin
        if(inrow!=4'b1111)
        begin
            state<=5;
        end     
        else
        begin
            state<=3;col<=4'b1011;
        end
    end
    3:
    begin
        if(inrow!=4'b1111)
        begin
            state<=5;
        end     
        else
        begin
            state<=4;col<=4'b0111;
        end
    end
    4:  
    begin
        if(inrow!=4'b1111)
        begin
            state<=5;
        end
        else state<=0;
    end
    5:
    begin
        if(inrow!=4'b1111)
        begin
            inrow_reg<=inrow;    //保存扫描行值   //读得
            outcol_reg<=col;     //保存扫描列值
            key_flag<=1'b1;      //有键按下为1
            state<=5;            //连续扫描状态5直至无按键按下，从0开始
        end
        else    state<=0;
    end
endcase
end 
/////////////////////////////////////////////////////////
always@(clock)
begin
		if (keynum_1 == {outcol_reg,inrow_reg}) 
        begin //连续2次检测到的按键值相同，稳定
			jud_flag<=1;
        end
        else 
        begin
			jud_flag<=0;
			keynum_1<={outcol_reg,inrow_reg};
        end
 
end
//对键盘扫描结果译码得到按键数值
always@(posedge clock)
begin
    if(key_flag==1'b1)
    begin
			
			    
			case({outcol_reg,inrow_reg})
            8'b1110_1110:begin  key_value<=0;lemp_0<=~lemp_0;end 
            8'b1110_1101:begin  key_value<=1;lemp_1<=~lemp_1;end 
            8'b1110_1011:begin  key_value<=2;lemp_2<=~lemp_2;end 
            8'b1110_0111:begin  key_value<=3;lemp_3<=~lemp_3;end 
            8'b1101_1110:begin  key_value<=4;lemp_4<=~lemp_4;end 
            8'b1101_1101:begin  key_value<=5;lemp_5<=~lemp_5;end 
            8'b1101_1011:begin  key_value<=6;lemp_6<=~lemp_6;end 
            8'b1101_0111:begin  key_value<=7;lemp_7<=~lemp_7;end 
            8'b1011_1110:begin  key_value<=8;lemp_8<=~lemp_8;end 
            8'b1011_1101:begin  key_value<=9;lemp_9<=~lemp_9;end 
            8'b1011_1011:begin key_value<=10;end
            8'b1011_0111:begin key_value<=11;end
            8'b0111_1110:begin key_value<=12;end
            8'b0111_1101:begin key_value<=13;end
            8'b0111_1011:begin key_value<=14;end
            8'b0111_0111:begin key_value<=16;end
            default: key_value <= 16; //无按键按下或无效按键组合
			endcase
    end
end

assign key_ready=key_flag;
assign outcol=col;

endmodule